<tool id="blastn" name="Identify reads with blastn and find taxonomy">
    <description>blastn wrapper and taxonomy finder</description>
    <command interpreter="bash">
        blastn.sh
        $input_type.type
        $input_type.input
        $database
        $task
        $max_target_seqs
        $taxidlist
        $output_format.output_format_type
        $log_output
        #if $input_type.type == "fasta"
        $blast_output_fasta
        #elif $input_type.type == "zip"
        $blast_output_zip
        #end if
        $output_format.taxonomy_method
    </command>
    <macros>
        <macro name="zip_file_input_macro">
            <param format="zip" name="input" type="data" label="zip file containing fasta"/>
        </macro>
        <macro name="fasta_file_input_macro">
            <param format="fasta" name="input" type="data" label="fasta file"/>
        </macro>
        <macro name="taxonomy_macro">
            <!--
            <param name="taxonomy_method" type="select" multiple="false" label="Taxonomy source">
                <option value="ncbi" selected="true">NCBI</option>
                <option value="gbif">GBIF</option>
            </param>-->
            <param name="taxonomy_method" type="select" multiple="false" label="Taxonomy source" dynamic_options="taxonomy_source_list(database)"/>
        </macro>

    </macros>
    <inputs>
        <conditional name="input_type">
            <param name="type" type="select" multiple="false" label="Input type">
                <option value="zip">zip</option>
                <option value="fasta" selected="true">fasta</option>
            </param>
            <when value="zip">
                <expand macro="zip_file_input_macro"/>
            </when>
            <when value="fasta">
                <expand macro="fasta_file_input_macro"/>
            </when>
        </conditional>

        <param name="database" type="select" multiple="true" label="Database">
            <option value="/home/ubuntu/testmapMarten/test/Marten/github_scripts/galaxy-tool-BLAST/database/CO1v5" label="DatabaseCO1">CO1 (Genbank 04-06-2018)</option>
            <option value="/home/ubuntu/testmapMarten/test/BOLDv2">BOLD</option>
        </param>


        <param name="taxidlist" type="select" multiple="false" label="ncbi taxonomy filter">
            <option value="none" selected="true">None</option>
            <option value="/home/ubuntu/testmapMarten/test/Marten/github_scripts/galaxy-tool-BLAST/database/Actinopterygii_taxidlist">Actinopterygii</option>
        </param>

        <param name="taxidlist" type="select" multiple="false" label="NCBI taxonomy filter" dynamic_options="taxon_filter(database)"/>

        <param name="task" type="select" multiple="false" label="Task">
            <option value="blastn">blastn</option>
            <option value="megablast" selected="true">megablast</option>
        </param>

        <conditional name="output_format">
            <param name="output_format_type" type="select" multiple="false" label="Output format">
                <option value="custom_taxonomy" selected="true">With taxonomy (Default)</option>
                <option value="0">Pairwise (can be used with MEGAN)</option>
                <option value="6">Tabular</option>
                <option value="8">Text ASN.1</option>
                <option value="11">BLAST archive format (ASN.1)</option>
            </param>
            <when value="custom_taxonomy">
                <expand macro="taxonomy_macro"/>
            </when>
        </conditional>

        <param name="max_target_seqs" type="integer" label="Maximum number of BLAST hits per sequence" value="1" min="1"/>

    </inputs>
    <code file="/home/ubuntu/testmapMarten/test/Marten/github_scripts/galaxy-tool-BLAST/test_tool_form_utils.py"/>

    <outputs>
        <data format="txt" type="data" name="log_output" label="$input_type.input.display_name log"/>
        <!--<data format="tabular" type="data" name="blast_output" label="$input_type.input.display_name BLAST" />-->
        <data format="zip" type="data" name="blast_output_zip" label="$input_type.input.display_name BLAST">
            <filter>input_type['type'] != "fasta"</filter>
        </data>

        <data format="tabular" type="data" name="blast_output_fasta" label="$input_type.input.display_name BLAST">
            <filter>input_type['type'] == "fasta"</filter>
            <change_format>
                <when input="output_format.output_format_type" value="custom_taxonomy" format="tabular"/>
                <when input="output_format.output_format_type" value="6" format="tabular"/>
                <when input="output_format.output_format_type" value="8" format="txt"/>
                <when input="output_format.output_format_type" value="11" format="txt"/>
            </change_format>
        </data>

    </outputs>
    <tests>
        <test>
            <param name="test_input" value="test_input.txt"/>
            <output name="test_outout" file="test_output.txt"/>
        </test>
    </tests>
    <help>
    </help>
</tool>